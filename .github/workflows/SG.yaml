name: Update SG.yaml
on:
  push:
    paths:
      - 'SG.list'
  workflow_dispatch:
jobs:
  process-file:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Process SG.list
      run: |
        # 确保在仓库的根目录下
        cd $GITHUB_WORKSPACE
        # 创建Clash文件夹（如果尚未存在）
        mkdir -p Clash
        
        # 处理文件：删除#开头的行和空白行，并在每行开头添加"  - "
        awk '!/^#/ && NF {print "  - "$0}' SG.list > Clash/SG.yaml
        
        # 在文件开头插入"payload:"
        sed -i '1ipayload:' Clash/SG.yaml
    - name: Commit changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Clash/SG.yaml
        git commit -m "Update Clash/SG.yaml from SG.list"
        git push
    - name: Delete previous workflow runs
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Retrieve the list of workflow runs, sort by creation date, and skip the latest one
        runs_to_delete=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs" \
            | jq '.workflow_runs | sort_by(.created_at) | reverse | .[1:] | .[].id')
        for run_id in $runs_to_delete; do
          # Delete each workflow run
          curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id"
        done
